function t(t,e){Object.entries(t).forEach(e)}const e=function*(){let t=0;for(;;)yield t++}();class s{constructor(){const e={};t(this._privates(),([t,s])=>{e[t]={value:s}}),Object.defineProperties(this,e)}_privates(){return{_F_obs:new Map}}listen(e,s){s?this._listen(e,s):t(e,([t,e])=>this._listen(t,e))}unlisten(t,e){const s=this._F_obs.get(t);s&&s.delete(e)}unescapeHtml(t){return(new DOMParser).parseFromString(t,"text/html").documentElement.textContent}say(t,e){this._say(t,t,e),this._say("*",t,e)}_listen(t,e){const s=this._F_obs.get(t);s?s.add(e):this._F_obs.set(t,new Set([e]))}_say(t,e,s){const i=this._F_obs.get(t);void 0!==i&&i.forEach(t=>{if(this._isFn(t))return void t.call(this,s);let i=t[e];this._isFn(i)&&i.call(t,s)})}_callR(t,e,s,i){let n=i?this[i]:this;n&&(n=n[s]),n&&n.apply(this,t);const r=this[e];if(r)for(let n in r){const o=r[n];o._callR&&o._callR(t,e,s,i)}}_isStr(t){return"string"==typeof t}_isFn(t){return"function"==typeof t}}class i{constructor(t,e){if(this.req=t,"string"==typeof e)this.res=null,this.isTimeout="timeout"===e,this.isAborted="abort"===e,this.isNetworkError="error"===e;else{this.res=e;let t=this.res.status;this.isBadRequest=400===t,this.isUnauthorized=401===t,this.isForbidden=403===t,this.isNotFound=404===t,this.isConflict=409===t,this.isServerError=t>=500}}}class n{constructor(t={}){this.baseURL=t.baseURL||"",this.headers=t.headers||{},this.afterError=t.afterError||function(){},this.authorize=t.authorize||function(){},this.unauthorized=t.unauthorized||function(){},(t.bodyType||"").includes("form")?this.contentType="application/x-www-form-urlencoded":this.contentType="application/json;charset=UTF-8"}get(t,e={}){const{query:s,body:i,headers:n}=e;return this.exec("GET",t,s,i,n)}post(t,e={}){const{query:s,body:i,headers:n}=e;return this.exec("POST",t,s,i,n)}put(t,e={}){const{query:s,body:i,headers:n}=e;return this.exec("PUT",t,s,i,n)}patch(t,e={}){const{query:s,body:i,headers:n}=e;return this.exec("PATCH",t,s,i,n)}delete(t,e={}){const{query:s,body:i,headers:n}=e;return this.exec("DELETE",t,s,i,n)}async exec(t,e,s,n,r={}){"Content-Type"in r||(r["Content-Type"]=this.contentType);const o={method:t,path:e,headers:r};let a;try{await this.authorize(e,{query:s,body:n,headers:r});const h=await this._request(t,e,{query:s,body:n,headers:r}),l=h.status;if(l<400)return h;if(a=new i(o,h),401===l)return void this.unauthorized(a)}catch(t){return new i(o,t)}if(a)throw a}_request(t,e,{query:s,body:i,headers:n}){let r;if(i){const t=n["Content-Type"];if(t.match(/\/form-data/)){r=new FormData;for(let t in i)r.append(t,i[t]);delete n["Content-Type"]}else r=t.match(/\/json/)?JSON.stringify(i):this._formatParams(i)}else r=void 0;let o=e;return this.baseURL&&!o.match(/^[a-z]{0,4}\:\/\//)&&(o=this.baseURL+o),s&&(o+="?"+this._formatParams(s)),new Promise((e,s)=>{let i=new XMLHttpRequest;i.open(t,o,!0);for(let t in n)i.setRequestHeader(t,n[t]);i.onload=(t=>{let s,n=i.getResponseHeader("Content-Type");s=null===n?null:n.match(/\/json/)?JSON.parse(i.response):n.match(/\/form/)?this._fromFormData(i.response):i.response,e({status:i.status,headers:i.getAllResponseHeaders(),body:s})}),i.onabort=function(t){s("abort")},i.onerror=function(t){s("error")},i.ontimeout=function(t){s("timeout")},i.send(r)})}_formatParams(t){return new URLSearchParams(t).toString()}_fromFormData(t){const e={};return t.split("&").forEach(t=>{const[s,i]=t.split("=");e[decodeURIComponent(s)]=decodeURIComponent(i)}),e}}class r extends s{constructor(t={}){super(),Object.assign(this,t)}add(t,e){const s=this[t];let i;void 0!==s&&s instanceof Array?(s.push(e),i=s):i=s+e,this._updateField(t,i)}toggle(t){const e=Boolean(this[t]);this._updateField(t,!e)}update(e){t(e,([t,e])=>this._updateField(t,e))}destroy(){this.say("destroy",{})}_updateField(t,e){const s=this[t];s instanceof r?s instanceof o?s.reset(e):s.update(e):(this[t]=e,this.say("update",{field:t,newValue:e,oldValue:s}))}_addListener(t){this.listen("*",t)}_removeListener(t){this.unlisten("*",t)}}class o extends r{constructor(t=[],e={}){super(),e.wrapItem?!0===e.wrapItem?this._F_itemClass=r:this._F_itemClass=e.wrapItem:this._F_itemClass=null,this._data=t.map(t=>this._wrapItem(t))}itemClass(t){return this._F_itemClass}get(t){return this._data[t]}add(t,e){t=this._wrapItem(t),void 0===e?this._data.push(t):this._data.splice(e,0,t),this.say("add",{item:t,index:e})}update(t,e){void 0===e&&(e=this._data.indexOf(t)),this._data[e]!==t&&(t=this._wrapItem(t),this._data[e]=t),this.say("update",{item:t,index:e})}remove(t){let e;e="number"!=typeof t?this._data.indexOf(t):t;const s=this._data.splice(e,1)[0];this.say("remove",{item:s,index:e})}addAll(t,e){t.forEach(t=>this.add(t,e))}removeAll(t={}){const{reverse:e=!1}=t;if(e)for(let t=this.length-1;t>=0;t--)this.remove(t);else for(;this._data.length;)this.remove(0)}removeLast(){this.remove(this.length-1)}reset(t=[]){this.removeAll(),this.addAll(t)}find(t,e){const s=this.indexOf(t,e);return s>=0?this._data[s]:void 0}indexOf(t,e){let s;if(void 0!==e)s=(s=>s[t]===e);else{if(!this._isFn(t))return this._data.indexOf(t);s=t}for(let t=0,e=this._data.length;t<e;t++)if(s(this._data[t]))return t;return-1}forEach(t){this._data.forEach(t)}some(t){return this._data.some(t)}get length(){return this._data.length}[Symbol.iterator](){return this._data[Symbol.iterator]()}_wrapItem(t){if(!(t instanceof r)){const e=this.itemClass(t);if(e)return new e(t)}return t}}class a{constructor(t){this._item=t,t._addListener(this)}destroy(){this._item._removeListener(this),this._item=null}}class h extends a{constructor(t,e){super(t),this._view=e}update({field:t,newValue:e,oldValue:s}){this._view._updateField(t,e,s)}}class l extends a{constructor(t,e){super(t),this._view=e}add({item:t,index:e}){void 0===e?this._view.addItem(t):this._view.insertItem(t,e)}update({item:t,index:e}){this._view.updateItem(t,e)}remove({item:t,index:e}){this._view.removeItem(t,e)}}const d=["click","submit","change"];class c extends s{constructor(t,e){super(),this.el=null,this.views={},void 0===e&&t&&t.constructor===Object&&(e=t,t=null),this._build(t,e||{})}_privates(){return Object.assign(super._privates(),{_F_onevts:new Set,_F_binders:[],_F_elcache:{}})}init(t){}load(t){}handle(t){}unload(){}broadcast(t,e=[]){this._callR(e,"views",t)}_build(t,e){console.log("View#_build",t,e);const s=this._setupProps(e),i=this.init(s);this._data=void 0!==i?i:s,this._setRootNode(t,e.parent||null,this._data),this.el&&this._loadFinish()}_setupProps(t){let e;return t&&(e=t.data,"data"in t&&delete t.data,Object.assign(this,t)),e}_setRootNode(t,e,s){if(!t&&this.html)this.el=t=this._buildFromHtml(s),e&&e.appendEl(t);else if(this._isStr(t)){if(this.el=e?e.findEl(t):document.querySelector(t),!this.el)throw new Error(`Failed to create View because element not found ID: ${t}`)}else t&&(this.el=t)}_loadFinish(){const t=this.container;this.container=this._isStr(t)?this.findEl(t):this.el,this._loadViewsEvts(),this._setDataToUI(),this._bindData()}_loadViewsEvts(){console.log("View#_loadViewsEvts",this),this.load(this.views),t(this.views,([t,e])=>{if(e.el){if(e.el.parentNode instanceof DocumentFragment){const s=this.findEl(t);s?s.parentNode.replaceChild(e.el,s):this.appendEl(e.el)}}else e.el=this.findEl(t),e._loadFinish()});const e={};this.handle(e),this._setupEvts(c._parseEvts(e))}_bindData(){const t=this._data;t instanceof r&&this._F_binders.push(new h(t,this))}_unbindData(){const t=this._F_binders.pop();t&&t.destroy()}get data(){return this._data}set data(t){console.log("View#data=",this),this._data=t,this._unbindData(),this._setDataToUI(),this._bindData()}findEl(t){const e=this._F_elcache[t];return e&&e.parentNode?e:this._F_elcache[t]=this.el.querySelector(`[data-id="${t}"]`)||document.getElementById(t)}appendEl(t){this.container.appendChild(t)}add(t,e){this.views[t]=e,this.appendEl(e.el)}remove(t){const e=this.views[t];e.destroy(),e.el.remove(),delete this.views[t]}fire(t,e){const s=e?new CustomEvent(t,{detail:e,bubbles:!0}):new Event(t,{bubbles:!0});this.el.dispatchEvent(s)}destroy(){this.unload(),Object.values(this.views).forEach(t=>t.destroy()),this.views={},this._F_elcache.clear(),this._unbindData(),this._teardownEvts(),this.parent=null}_setDataToUI(){const e=this._data;void 0!==e&&e instanceof Object&&(console.log("View#_setDataToUI",this),t(this._data,([t,e])=>{this._setFieldValue(t,e)}))}_updateField(t,e,s){this._setFieldValue(t,e)}_setFieldValue(t,e){if(t in this.views)return void(this.views[t].data=e);const s=this.findEl(t);s&&(s.dataset&&"html"===s.dataset.type?s.innerHTML=e:"value"in s?s.value=e:s.textContent=e)}_setupEvts(e){t(e,([t,e])=>{if("_"===t)return void this._setEvts(this.el,e);const s=this.findEl(t);s?(s instanceof NodeList?Array.from(s):[s]).forEach(t=>this._setEvts(t,e)):console.log(`Not found event target ${t}`)})}_setEvts(e,s){t(s,([t,s])=>{this._trapEvt(this,e,t,s)})}_trapEvt(t,e,s,i){const n=function(e){const s=i.call(t,this,e);return void 0!==s&&s};d.includes(s)?e["on"+s]=n:e.addEventListener(s,n),this._F_onevts.add([e,s,n])}_teardownEvts(){const t=this._F_onevts;t.forEach(([t,e,s])=>{d.includes(e)?t["on"+e]=null:t.removeEventListener(e,s)}),t.clear()}_buildFromHtml(t){const e=document.createElement("template");e.innerHTML=this.html(t||{});const s=document.adoptNode(e.content);return this._firstEl(s)}_firstEl(t){const e=t.firstElementChild;if(void 0!==e)return e;const s=t.childNodes;for(let t=0,e=s.length;t<e;t++){const e=s[t];if(e.nodeType===Node.ELEMENT_NODE)return e}return null}static _parseEvts(e){const s={_:{}};return t(e,([t,e])=>{const i=t.lastIndexOf("_");if(-1===i)return void(s._[t]=e);const n=t.substr(0,i),r=t.substr(i+1),o=s[n];o?o[r]=e:s[n]={[r]:e}}),s}}class u extends c{title(){return""}destroy(){super.destroy(),this.el.remove()}}class _{constructor(t,e){this._routeTree=this._parseRoute(t),this._lastRoute=null,this.onMove=e}canGo(t){return null!==this.getRoute(t)}move(t){this.onMove(this.getRoute(t))}getRoute(t){t.startsWith("/")||(t="/"+t);let e=t;"/"===e&&(e+="index"),(e=this._chopEndSlash(e)).endsWith(".html")&&(e=e.substr(0,e.length-5));const s=this._parsePath(e);let i,n=this._routeTree,r={},o=null;for(;void 0!==(i=s.shift());){let a;if(i in n)a=n[i];else{if(!("_any_"in n))throw alert(`${e} page isn't defined`),"/";if(r[n._any_.id]=i,n=n._any_.children,s.length>0)continue;a=n.index}if(this._isStr(a)){const e=this._resolve(t,a);return window.history.replaceState(null,null,e),this.getRoute(e)}a.prototype instanceof u?o={view:a,ctx:r}:(n=a,0===s.length&&s.unshift("index"))}if(o)return o;throw alert(`${path} page not found`),"/"}_parsePath(t){const e=t.split("/");return e.shift(),e}_parseRoute(e){const s={};return t(e,([t,e])=>{const i=e.prototype instanceof u||this._isStr(e);if(t.startsWith(":")){(s._any_={id:t.substr(1)}).children=i?{index:e}:this._parseRoute(e)}else s[t]=i?e:this._parseRoute(e)}),s}_resolve(t,e){if(e.startsWith("/"))return e;const s=t.split("/");let i;for(;i=e.match(/^\.\.\/?(.*)$/);)s.pop(),e=i[1];return s.join("/")+e}_chopEndSlash(t){return t.endsWith("/")?t.substr(0,t.length-1):t}_isStr(t){return"string"==typeof t}}class p extends _{constructor(t,e,s){super(t,e);let i=s;if(!i){let t=document.querySelector("base");if(t){const{pathname:e}=new URL(t.href);i=this._chopEndSlash(e)}}this.basePath=i||""}depart(){document.addEventListener("click",t=>{this._captureClick(t)},!0);const t=t=>{try{this.move(t)}catch(t){this._isStr(t)?window.location.href=this.basePath+t:console.error(t)}};window.onpopstate=(e=>{t(e.state?e.state.path:"/")});let e=window.location.pathname.substr(this.basePath.length);e.length>1&&e.endsWith("/")&&(e=e.substr(0,e.length-1),window.history.replaceState(null,null,e)),t(e)}go(t){const e=window.history;e&&e.pushState&&(e.pushState({path:t},null,this.basePath+t),this.move(t))}_captureClick(t){const e=document.activeElement;if(e&&"A"===e.tagName&&"_top"!==e.target&&e.href.startsWith(window.location.origin+this.basePath)){t.preventDefault();try{this.go(e.pathname.substr(this.basePath.length))}catch(t){this._isStr(t)?this.go(t):console.error(t)}}}}class m extends _{constructor(t,e,s="#!"){super(t,e),this.head=s}get curPath(){return window.location.hash.substr(this.head.length)}depart(){const t=t=>{try{this.move(t)}catch(t){this._isStr(t)?window.location.hash=this.head+t:console.error(t)}};window.onhashchange=(e=>{t(this.curPath||"/")}),t(this.curPath)}go(t){window.location.hash=this.head+t}}var f=new class{constructor(){}activate(t,e,s={}){this._rootArea=new t,this._curPage=null;const i=t=>{this._onMove(t)};this._router="HISTORY"===s.mode?new p(e,i,s.rootPath):new m(e,i,s.pathHead),window.onload=(t=>{this._router.depart()})}go(t,e){return this._preCtx=e,this._router.go(t),!1}back(){return window.history.back(),!1}_onMove({view:t,ctx:e}){this._preCtx&&(e=Object.assign(e||{},this._preCtx),this._preCtx=null),this._replaceContent(t,e),this._updateTitle()}_replaceContent(t,e){const s=this._curPage;s&&s.destroy();const i=Object.assign({},this._rootArea.context);this._curPage=new t({parent:this._rootArea,context:Object.assign(i,e)})}_updateTitle(){let t="";this._curPage&&(t=this._curPage.title()),document.title=this._rootArea.title(t)}};class v extends c{constructor(){let t,e={};for(let s of arguments)s instanceof Node||"string"==typeof s?t=s:s&&s.constructor===Object?Object.assign(e,s):void 0!==s&&(e._F_tmpl=s);super(t,e)}_privates(){const t=super._privates();return t._F_itemSet=new Map,t}itemViewClass(t){return this._F_tmpl}addItem(t){const e=this._createViewByItem(t);return this.addItemEl(this.container,e.el),e}insertItem(t,e){const s=this._createViewByItem(t);return this.insertItemEl(this.container,s.el,this._childElAt(e)),s}updateItem(t,e){const s=this._childElAt(e).getAttribute("_lfid_");this._F_itemSet.set(s,t),this.views[s].data=t}removeItem(t,e){const s=this._childElAt(e);this._removeItemByEl(s)}removeItemByView(t){this._removeItemByEl(t.el)}addItemEl(t,e){t.appendChild(e)}insertItemEl(t,e,s){t.insertBefore(e,s)}removeItemEl(t,e){t.removeChild(e)}_childElAt(t){return this.container.children[t]}_createViewByItem(t){const s=`_F_${e.next().value}`,i=new(this.itemViewClass(t))({data:t});return this._F_itemSet.set(s,i),this.views[s]=i,i.el.setAttribute("_lfid_",s),i}_removeItemByEl(t){const e=t.getAttribute("_lfid_");this._F_itemSet.delete(e);const s=this.views;s[e].unload(),delete s[e],this.removeItemEl(this.container,t)}_bindData(){const t=this._data;t instanceof o&&this._F_binders.push(new l(t,this))}_setDataToUI(){if(void 0!==this._data){console.log("ListView#_setDataToUI",this);for(let t of Object.values(this.views))this.removeItemByView(t);for(let t of this._data)this.addItem(t)}}}class w extends c{get data(){return this._assignFromFields(this._data)}set data(t){super.data=t}getValueOf(t){const e=this.findEl(t);if(e)return this._valueAsType(e);const s=this.views[t];return s?s.data:void 0}findEl(t){return this.el[t]||super.findEl(t)}_assignFromFields(e={}){const s=Object.assign({},e);for(let[t,e]of new FormData(this.el))s[t]=this._valueAsType(this.el[t]);for(let t of this.el.querySelectorAll("[data-id]")){const e=this._valueAsType(t);void 0!==e&&(s[t.dataset.id]=e)}return t(this.views,([t,e])=>{s[t]=e.data}),s}_valueAsType(t){const e=(t.dataset||{}).type||"text";let s=t.value;return"number"===e?s=Number(s):e.startsWith("bool")&&(s=Boolean(s)),s}_setFieldValue(t,e){const s=this.el[t];s?s.value=e:super._setFieldValue(t,e)}}export{f as App,s as Core,w as FormView,n as HttpClient,i as HttpError,r as Item,o as List,v as ListView,u as Page,c as View};
