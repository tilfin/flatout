function t(t,e){Object.entries(t).forEach(e)}const e=function*(){let t=0;for(;;)yield t++}();class s{constructor(){const e={};t(this._privates(),([t,s])=>{e[t]={value:s}}),Object.defineProperties(this,e)}_privates(){return{_F_obs:new Map}}listened(e,s){s?this._listened(e,s):t(e,([t,e])=>this._listened(t,e))}unlistened(t,e){const s=this._F_obs.get(t);s&&s.delete(e)}unescapeHtml(t){return(new DOMParser).parseFromString(t,"text/html").documentElement.textContent}say(t,e){this._say(t,t,e),this._say("*",t,e)}_listened(t,e){const s=this._F_obs.get(t);s?s.add(e):this._F_obs.set(t,new Set([e]))}_say(t,e,s){const i=this._F_obs.get(t);void 0!==i&&i.forEach(t=>{if(this._isFn(t))return void t.call(this,s);let i=t[e];this._isFn(i)&&i.call(t,s)})}_callR(t,e,s,i){let n=i?this[i]:this;n&&(n=n[s]),n&&n.apply(this,t);const a=this[e];if(a)for(let n in a){const r=a[n];r._callR&&r._callR(t,e,s,i)}}_isStr(t){return"string"==typeof t}_isFn(t){return"function"==typeof t}}class i{constructor(t,e){if(this.req=t,"string"==typeof e)this.res=null,this.isTimeout="timeout"===e,this.isAborted="abort"===e,this.isNetworkError="error"===e;else{this.res=e;let t=this.res.status;this.isBadRequest=400===t,this.isUnauthorized=401===t,this.isForbidden=403===t,this.isNotFound=404===t,this.isConflict=409===t,this.isServerError=t>=500}}}class n{constructor(t={}){this.baseURL=t.baseURL||"",this.headers=t.headers||{},this.beforeRequest=t.beforeRequest||(async()=>{}),this.beforeError=t.beforeError||(async()=>!0),(t.bodyType||"").includes("form")?this.contentType="application/x-www-form-urlencoded":this.contentType="application/json;charset=UTF-8"}get(t,e={}){const{query:s,body:i,headers:n}=e;return this.exec("GET",t,s,i,n)}post(t,e={}){const{query:s,body:i,headers:n}=e;return this.exec("POST",t,s,i,n)}put(t,e={}){const{query:s,body:i,headers:n}=e;return this.exec("PUT",t,s,i,n)}patch(t,e={}){const{query:s,body:i,headers:n}=e;return this.exec("PATCH",t,s,i,n)}delete(t,e={}){const{query:s,body:i,headers:n}=e;return this.exec("DELETE",t,s,i,n)}async exec(t,e,s,n,a={}){"Content-Type"in(a=Object.assign({},this.headers,a))||(a["Content-Type"]=this.contentType),await this.beforeRequest(e,{query:s,body:n,headers:a});const r={method:t,path:e,headers:a};let o;try{const h=await this._request(t,e,{query:s,body:n,headers:a}),{status:l}=h;if(l<400)return h;o=new i(r,h)}catch(t){o=new i(r,t)}if(!1!==await this.beforeError(o))throw o}_request(t,e,{query:s,body:i,headers:n}){let a;if(i){const t=n["Content-Type"];if(t.match(/\/form-data/)){a=new FormData;for(let t in i)a.append(t,i[t]);delete n["Content-Type"]}else a=t.match(/\/json/)?JSON.stringify(i):this._formatParams(i)}else a=void 0;let r=e;return this.baseURL&&!r.match(/^[a-z]{2,5}:\/\//)&&(r=this.baseURL+r),s&&(r+="?"+this._formatParams(s)),new Promise((e,s)=>{let i=new XMLHttpRequest;i.open(t,r,!0);for(let t in n)i.setRequestHeader(t,n[t]);i.onload=(t=>{let s,n=i.getResponseHeader("Content-Type");s=null===n?null:n.match(/\/json/)?JSON.parse(i.response):n.match(/\/form/)?this._fromFormData(i.response):i.response,e({status:i.status,headers:i.getAllResponseHeaders(),body:s})}),i.onabort=function(t){s("abort")},i.onerror=function(t){s("error")},i.ontimeout=function(t){s("timeout")},i.send(a)})}_formatParams(t){return new URLSearchParams(t).toString()}_fromFormData(t){const e={};return t.split("&").forEach(t=>{const[s,i]=t.split("=");e[decodeURIComponent(s)]=decodeURIComponent(i)}),e}}class a extends s{constructor(t={}){super(),Object.assign(this,t)}add(t,e){const s=this[t];let i;void 0!==s&&s instanceof Array?(s.push(e),i=s):i=s+e,this._updateField(t,i)}toggle(t){const e=Boolean(this[t]);this._updateField(t,!e)}update(e){t(e,([t,e])=>this._updateField(t,e))}destroy(){this.say("destroy",{})}_updateField(t,e){const s=this[t];s instanceof a?s instanceof r?s.reset(e):s.update(e):(this[t]=e,this.say("update",{field:t,newValue:e,oldValue:s}))}}class r extends a{constructor(t=[],e={}){super(),e.wrapItem?!0===e.wrapItem?this._F_itemClass=a:this._F_itemClass=e.wrapItem:this._F_itemClass=null,this._data=t.map(t=>this._wrapItem(t))}itemClass(t){return this._F_itemClass}get(t){return this._data[t]}add(t,e){t=this._wrapItem(t),void 0===e?this._data.push(t):this._data.splice(e,0,t),this.say("add",{item:t,index:e})}update(t,e){void 0===e&&(e=this._data.indexOf(t)),this._data[e]!==t&&(t=this._wrapItem(t),this._data[e]=t),this.say("update",{item:t,index:e})}remove(t){let e;e="number"!=typeof t?this._data.indexOf(t):t;const s=this._data.splice(e,1)[0];this.say("remove",{item:s,index:e})}addAll(t,e){t.forEach(t=>this.add(t,e))}removeAll(t={}){const{reverse:e=!1}=t;if(e)for(let t=this.length-1;t>=0;t--)this.remove(t);else for(;this._data.length;)this.remove(0)}removeLast(){this.remove(this.length-1)}reset(t=[]){this.removeAll(),this.addAll(t)}find(t,e){const s=this.indexOf(t,e);return s>=0?this._data[s]:void 0}indexOf(t,e){let s;if(void 0!==e)s=(s=>s[t]===e);else{if(!this._isFn(t))return this._data.indexOf(t);s=t}for(let t=0,e=this._data.length;t<e;t++)if(s(this._data[t]))return t;return-1}forEach(t){this._data.forEach(t)}some(t){return this._data.some(t)}get length(){return this._data.length}[Symbol.iterator](){return this._data[Symbol.iterator]()}_wrapItem(t){if(!(t instanceof a)){const e=this.itemClass(t);if(e)return new e(t)}return t}}class o{constructor(t){this._item=t,t.listened("*",this)}destroy(){this._item.unlistened("*",this),this._item=null}}class h extends o{constructor(t,e){super(t),this._view=e}update({field:t,newValue:e,oldValue:s}){this._view.update(t,e,s)}}class l extends o{constructor(t,e){super(t),this._view=e}add({item:t,index:e}){void 0===e?this._view.addItem(t):this._view.insertItem(t,e)}update({item:t,index:e}){this._view.updateItem(t,e)}remove({item:t,index:e}){this._view.removeItem(t,e)}}const d=["click","submit","change"];class c extends s{constructor(t={}){super(),this.el=null,this.views={};const{rootEl:e,...s}=t;this._build(e,s)}_privates(){return Object.assign(super._privates(),{_F_onevts:new Set,_F_binders:[],_F_elcache:new Map,_F_emap:{_:{}}})}init(t){}load(t){}handle(t){}completed(){}unload(){}broadcast(t,e=[]){this._callR(e,"views",t)}_build(t,e){const s=this._setupProps(e),i=this.init(s);this._data=void 0!==i?i:s,this._setRootNode(t,e.parent||null,this._data),this.el&&this._loadFinish()}_setupProps(t){let e;return t&&(e=t.data,"data"in t&&delete t.data,Object.assign(this,t)),e}_setRootNode(t,e,s){if(this._isStr(t)&&!(t=e?e.findEl(t):document.getElementById(t)))throw new Error(`Failed to create View because element not found ID: ${t}`);this.html?(this.el=this._buildFromHtml(s),e?e.appendEl(this.el):t&&t.parentNode.replaceChild(this.el,t)):t&&(this.el=t)}_loadFinish(){const t=this.contentEl;this.contentEl=this._isStr(t)?this.findEl(t):this.el,this._loadViewsEvts(),this._setDataToUI(),this._bindData(),this.completed()}_loadViewsEvts(){this.load(this.views),t(this.views,([t,e])=>{if(e.el){if(e.el.parentNode instanceof DocumentFragment){const s=this.findEl(t);s?s.parentNode.replaceChild(e.el,s):this.appendEl(e.el)}}else e.el=this.findEl(t),e._loadFinish()});const e={},s=this._F_emap;this.handle(e),this._parseEvts(e,s),t(s,([t,e])=>{if("_"===t)return void this._setEvts(this.el,e);const s=this.findEl(t);s&&this._setEvts(s,e)})}_bindData(){const t=this._data;t instanceof a&&this._F_binders.push(new h(t,this))}_unbindData(){const t=this._F_binders.pop();t&&t.destroy()}get data(){return this._data}set data(t){this._data=t,this._unbindData(),this._setDataToUI(),this._bindData()}findEl(t){const e=this._F_elcache.get(t);if(e&&e.parentNode)return e;const s=this.el.querySelector(`[data-id="${t}"]`)||document.getElementById(t);return this._F_elcache.set(t,s),s}appendEl(t){this.contentEl.appendChild(t)}set(t,e){const s=this,i=s.views[t];i&&(i.destroy(),i.el.remove(),delete s.views[t]),e&&(s.views[t]=e,s.appendEl(e.el),s._setEvts(e.el,s._F_emap[t]||{}))}fire(t,e){const s=e?new CustomEvent(t,{detail:e,bubbles:!0}):new Event(t,{bubbles:!0});this.el.dispatchEvent(s)}destroy(){this.unload(),Object.values(this.views).forEach(t=>t.destroy()),this.views={},this._F_elcache.clear(),this._unbindData(),this._teardownEvts(),this.parent=null}update(t,e,s){return this._setFieldValue(t,e)}_setDataToUI(){const e=this._data;void 0!==e&&(e instanceof Object?t(e,([t,e])=>this._setFieldValue(t,e)):this._setVal(this.el,e))}_setFieldValue(t,e){const s=this.views[t];if(s)return s.data=e,!0;const i=this.findEl(t);return!!i&&(this._setVal(i,e),!0)}_setVal(t,e){t.dataset&&"html"===t.dataset.type?t.innerHTML=e:"value"in t?t.value=e:t.textContent=e}_parseEvts(e,s){t(e,([t,e])=>{const i=t.lastIndexOf("_");if(-1===i)return void(s._[t]=e);const n=t.substr(0,i),a=t.substr(i+1),r=s[n];r?r[a]=e:s[n]={[a]:e}})}_setEvts(e,s){const i=e instanceof NodeList?Array.from(e):[e];t(s,([t,e])=>{i.forEach(s=>this._trapEvt(this,s,t,e))})}_trapEvt(t,e,s,i){const n=function(e){let s;try{s=i.call(t,this,e)}catch(t){}return void 0!==s&&s};d.includes(s)?e["on"+s]=n:e.addEventListener(s,n),this._F_onevts.add([e,s,n])}_teardownEvts(){const t=this._F_onevts;t.forEach(([t,e,s])=>{d.includes(e)?t["on"+e]=null:t.removeEventListener(e,s)}),t.clear()}_buildFromHtml(t){const e=document.createElement("template");e.innerHTML=this.html(t||{});const s=document.adoptNode(e.content);return this._firstEl(s)}_firstEl(t){const e=t.firstElementChild;if(void 0!==e)return e;const s=t.childNodes;for(let t=0,e=s.length;t<e;t++){const e=s[t];if(e.nodeType===Node.ELEMENT_NODE)return e}return null}}class u extends c{title(){return""}destroy(){super.destroy(),this.el.remove()}}class _{constructor(t,e){this._routeTree=this._parseRoute(t),this._lastRoute=null,this.onMove=e}canGo(t){return null!==this.getRoute(t)}move(t){this.onMove(this.getRoute(t))}getRoute(t){t.startsWith("/")||(t="/"+t);let e=t;"/"===e&&(e+="index"),(e=this._chopEndSlash(e)).endsWith(".html")&&(e=e.substr(0,e.length-5));const s=this._parsePath(e);let i,n=this._routeTree,a={},r=null;for(;void 0!==(i=s.shift());){let o;if(i in n)o=n[i];else{if(!("_any_"in n))throw alert(`${e} page isn't defined`),"/";if(a[n._any_.id]=i,n=n._any_.children,s.length>0)continue;o=n.index}if(this._isStr(o)){const e=this._resolve(t,o);return window.history.replaceState(null,null,e),this.getRoute(e)}o.prototype instanceof u?r={view:o,ctx:a}:(n=o,0===s.length&&s.unshift("index"))}if(r)return r;throw alert(`${t} page not found`),"/"}_parsePath(t){const e=t.split("/");return e.shift(),e}_parseRoute(e){const s={};return t(e,([t,e])=>{const i=e.prototype instanceof u||this._isStr(e);if(t.startsWith(":")){(s._any_={id:t.substr(1)}).children=i?{index:e}:this._parseRoute(e)}else s[t]=i?e:this._parseRoute(e)}),s}_resolve(t,e){if(e.startsWith("/"))return e;const s=t.split("/");let i;for(;i=e.match(/^\.\.\/?(.*)$/);)s.pop(),e=i[1];return s.join("/")+e}_chopEndSlash(t){return t.endsWith("/")?t.substr(0,t.length-1):t}_isStr(t){return"string"==typeof t}}class p extends _{constructor(t,e,s){super(t,e);let i=s;if(!i){let t=document.querySelector("base");if(t){const{pathname:e}=new URL(t.href);i=this._chopEndSlash(e)}}this.basePath=i||""}depart(){document.addEventListener("click",t=>{this._captureClick(t)},!0);const t=t=>{try{this.move(t)}catch(t){this._isStr(t)&&(window.location.href=this.basePath+t)}};window.onpopstate=(e=>{t(e.state?e.state.path:"/")});let e=window.location.pathname.substr(this.basePath.length);e.length>1&&e.endsWith("/")&&(e=e.substr(0,e.length-1),window.history.replaceState(null,null,e)),t(e)}go(t){const e=window.history;e&&e.pushState&&(e.pushState({path:t},null,this.basePath+t),this.move(t))}_captureClick(t){const e=document.activeElement;if(e&&"A"===e.tagName&&"_top"!==e.target&&e.href.startsWith(window.location.origin+this.basePath)){t.preventDefault();try{this.go(e.pathname.substr(this.basePath.length))}catch(t){this._isStr(t)&&this.go(t)}}}}class m extends _{constructor(t,e,s="#!"){super(t,e),this.head=s}get curPath(){return window.location.hash.substr(this.head.length)}depart(){const t=t=>{try{this.move(t)}catch(t){this._isStr(t)&&(window.location.hash=this.head+t)}};window.onhashchange=(e=>{t(this.curPath||"/")}),t(this.curPath)}go(t){window.location.hash=this.head+t}}var f=new class{constructor(){}activate(t,e,s={}){this._rootArea=new t,this._curPage=null;const i=t=>{this._onMove(t)};this._router="HISTORY"===s.mode?new p(e,i,s.rootPath):new m(e,i,s.pathHead);const n=t=>{this._router.depart()};"loading"!==document.readyState?n():document.addEventListener("DOMContentLoaded",n,!1)}go(t,e){return this._preCtx=e,this._router.go(t),!1}back(){return window.history.back(),!1}_onMove({view:t,ctx:e}){this._preCtx&&(e=Object.assign(e||{},this._preCtx),this._preCtx=null),this._replaceContent(t,e),this._updateTitle()}_replaceContent(t,e){const s=this._curPage;s&&s.destroy();const i=Object.assign({},this._rootArea.context);this._curPage=new t({parent:this._rootArea,context:Object.assign(i,e)})}_updateTitle(){let t="";this._curPage&&(t=this._curPage.title()),document.title=this._rootArea.title(t)}};class v extends c{constructor(t,e={}){e._F_tmpl=t,super(e)}_privates(){const t=super._privates();return t._F_itemSet=new Map,t}itemViewClass(t){return this._F_tmpl}addItem(t){const e=this._createViewByItem(t);return this.addItemEl(this.contentEl,e.el),e}insertItem(t,e){const s=this._createViewByItem(t);return this.insertItemEl(this.contentEl,s.el,this._childElAt(e)),s}updateItem(t,e){const s=this._childElAt(e).getAttribute("_lfid_");this._F_itemSet.set(s,t),this.views[s].data=t}removeItem(t,e){const s=this._childElAt(e);this._removeItemByEl(s)}removeItemByView(t){this._removeItemByEl(t.el)}addItemEl(t,e){t.appendChild(e)}insertItemEl(t,e,s){t.insertBefore(e,s)}removeItemEl(t,e){t.removeChild(e)}_childElAt(t){return this.contentEl.children[t]}_createViewByItem(t){const s=`_F_${e.next().value}`,i=new(this.itemViewClass(t))({data:t});return this._F_itemSet.set(s,i),this.views[s]=i,i.el.setAttribute("_lfid_",s),i}_removeItemByEl(t){const e=t.getAttribute("_lfid_");this._F_itemSet.delete(e);const s=this.views;s[e].unload(),delete s[e],this.removeItemEl(this.contentEl,t)}_bindData(){const t=this._data;t instanceof r&&this._F_binders.push(new l(t,this))}_setDataToUI(){if(void 0!==this._data){for(let t of Object.values(this.views))this.removeItemByView(t);for(let t of this._data)this.addItem(t)}}}class w extends c{get data(){return this._assignFromFields(this._data)}set data(t){super.data=t}getValueOf(t){const e=this.findEl(t);if(e)return this._valueAsType(e);const s=this.views[t];return s?s.data:void 0}findEl(t){return this.el[t]||super.findEl(t)}_assignFromFields(e={}){const s=Object.assign({},e);for(let[t,e]of new FormData(this.el))s[t]=this._valueAsType(this.el[t]);return t(this.views,([t,e])=>{s[t]=e.data}),s}_valueAsType(t){const e=(t.dataset||{}).type||"text";let s=t.value;return e.startsWith("date")||"datetime-local"===t.type?s=new Date(s):"number"===e?s=Number(s):e.startsWith("bool")&&(s=Boolean(s)),s}_setFieldValue(t,e){const s=this.el[t];if(s)return"datetime-local"===s.type&&(e=this.formatLocalDateTime(new Date(e))),void(s.value=e);super._setFieldValue(t,e)}formatLocalDateTime(t){return[t.getFullYear(),"-",("0"+(t.getMonth()+1)).slice(-2),"-",("0"+t.getDate()).slice(-2),"T",("0"+t.getHours()).slice(-2),":",("0"+t.getMinutes()).slice(-2)].join("")}}export{f as App,s as Core,w as FormView,n as HttpClient,i as HttpError,a as Item,r as List,v as ListView,u as Page,c as View};
//# sourceMappingURL=flatout.min.js.map
